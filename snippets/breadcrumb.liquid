{% comment %}
  Renders hierarchical breadcrumb navigation with full menu path

  Usage:
  {% render 'breadcrumb' %}
{% endcomment %}

{%- liquid
  # Function to find menu path for current collection/product
  # Returns array of menu items leading to current page
  
  assign menu_path = blank
  assign main_menu = blank
  assign menu_handle = blank
  
  # First try to get menu from header section configuration
  for section in sections
    if section.type == 'header' and section.settings.menu != blank
      assign menu_handle = section.settings.menu
      assign main_menu = linklists[menu_handle]
      break
    endif
  endfor
  
  # Fallback to common menu handles if no menu found
  if main_menu == blank
    if linklists['main-menu'] != blank
      assign menu_handle = 'main-menu'
      assign main_menu = linklists['main-menu']
    elsif linklists['header'] != blank  
      assign menu_handle = 'header'
      assign main_menu = linklists['header']
    elsif linklists['primary'] != blank
      assign menu_handle = 'primary'
      assign main_menu = linklists['primary']
    endif
  endif
  
  if request.page_type == 'product' and product and main_menu != blank
    for link in main_menu.links
      if link.links != blank
        for childlink in link.links
          if childlink.links != blank
            for grandchildlink in childlink.links
              # Check if this grandchild collection contains the product
              assign grandchild_collection_handle = grandchildlink.url | split: '/collections/' | last | split: '/' | first
              if product.collections contains collections[grandchild_collection_handle]
                assign menu_path = link.title | append: '|' | append: childlink.title | append: '|' | append: grandchildlink.title
                break
              endif
            endfor
            if menu_path != blank
              break
            endif
            # Check if this child collection contains the product
            assign child_collection_handle = childlink.url | split: '/collections/' | last | split: '/' | first
            if product.collections contains collections[child_collection_handle]
              assign menu_path = link.title | append: '|' | append: childlink.title
              break
            endif
          else
            # Check if this child collection contains the product (no grandchildren)
            assign child_collection_handle = childlink.url | split: '/collections/' | last | split: '/' | first
            if product.collections contains collections[child_collection_handle]
              assign menu_path = link.title | append: '|' | append: childlink.title
              break
            endif
          endif
        endfor
        if menu_path != blank
          break
        endif
      else
        # Check if this main link collection contains the product (no children)
        assign main_collection_handle = link.url | split: '/collections/' | last | split: '/' | first
        if product.collections contains collections[main_collection_handle]
          assign menu_path = link.title
          break
        endif
      endif
    endfor
  elsif request.page_type == 'collection' and collection and main_menu != blank
    for link in main_menu.links
      if link.links != blank
        for childlink in link.links
          if childlink.url == collection.url
            assign menu_path = link.title | append: '|' | append: childlink.title
            break
          endif
          if childlink.links != blank
            for grandchildlink in childlink.links
              if grandchildlink.url == collection.url
                assign menu_path = link.title | append: '|' | append: childlink.title | append: '|' | append: grandchildlink.title
                break
              endif
            endfor
            if menu_path != blank
              break
            endif
          endif
        endfor
        if menu_path != blank
          break
        endif
      endif
    endfor
  endif
  
  assign menu_levels = menu_path | split: '|'
-%}

<style>
  .breadcrumb {
    background: #f8f9fa !important;
    border-bottom: 1px solid #e5e7eb !important;
    padding: 12px 0 !important;
    font-size: 14px !important;
    z-index: -1 !important; /* NUCLEAR DESTRUCTION: Negative z-index üòÇ */
    position: relative !important;
  }
  
  .breadcrumb__list {
    display: flex !important;
    align-items: center !important;
    margin: 0 !important;
    padding: 0 24px !important;
    list-style: none !important;
    max-width: 1200px !important;
    margin: 0 auto !important;
  }
  
  .breadcrumb__item {
    display: flex !important;
    align-items: center !important;
  }
  
  .breadcrumb__link {
    color: rgba(0, 0, 0, 0.6) !important;
    text-decoration: none !important;
    transition: color 0.2s ease !important;
    text-transform: none !important;
    font-size: 13px !important;
    font-weight: 500 !important;
    font-family: 'Inter', 'Roboto', 'Noto Sans', var(--font-body-family), -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif !important;
  }
  
  .breadcrumb__link:hover {
    color: rgba(0, 0, 0, 0.8) !important;
  }
  
  .breadcrumb__current {
    color: rgba(0, 0, 0, 0.8) !important;
    font-weight: 600 !important;
    text-transform: none !important;
    font-size: 13px !important;
    font-family: 'Inter', 'Roboto', 'Noto Sans', var(--font-body-family), -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif !important;
  }
  
  .breadcrumb__separator {
    margin: 0 12px !important;
    color: rgba(0, 0, 0, 0.4) !important;
    font-size: 12px !important;
  }
</style>

<nav class="breadcrumb" aria-label="Breadcrumb">
  <!-- DEBUG: Remove this in production -->
  <div style="background: #f9f9f9; padding: 8px; margin: 8px 0; font-size: 11px; border: 1px solid #ddd;">
    <strong>üîç DEBUG:</strong> 
    Menu: {{ menu_handle | default: 'None' }} | 
    Found: {{ main_menu.title | default: 'None' }} | 
    Path: {{ menu_path | default: 'None' }}<br>
    <strong>All Menu Links:</strong>
    {%- for link in main_menu.links -%}
      {{ link.title }}
      {%- if link.links.size > 0 -%}
        ({{ link.links.size }} children)
      {%- endif -%}
      {% unless forloop.last %} | {% endunless %}
    {%- endfor -%}<br>
    
    <strong>URL Search Results:</strong><br>
    {%- assign menu_levels_debug = menu_path | split: '|' -%}
    {%- for level_debug in menu_levels_debug -%}
      {{ forloop.index }}. {{ level_debug }} ‚Üí 
      {%- assign found_url = blank -%}
      {%- for link in main_menu.links -%}
        {%- if link.title == level_debug -%}
          {%- assign found_url = link.url -%}
          {%- break -%}
        {%- endif -%}
        {%- if link.links != blank -%}
          {%- for childlink in link.links -%}
            {%- if childlink.title == level_debug -%}
              {%- assign found_url = childlink.url -%}
              {%- break -%}
            {%- endif -%}
            {%- if childlink.links != blank -%}
              {%- for grandchildlink in childlink.links -%}
                {%- if grandchildlink.title == level_debug -%}
                  {%- assign found_url = grandchildlink.url -%}
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {%- if found_url != blank -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
        {%- if found_url != blank -%}
          {%- break -%}
        {%- endif -%}
      {%- endfor -%}
      {{ found_url | default: 'NOT FOUND' }}<br>
    {%- endfor -%}
  </div>

  <ol class="breadcrumb__list">
    <!-- Home -->
    <li class="breadcrumb__item">
      <a href="{{ routes.root_url }}" class="breadcrumb__link">
        üè† Trang ch·ªß
      </a>
    </li>

    {%- if request.page_type != 'index' -%}
      <li class="breadcrumb__separator" aria-hidden="true">></li>
      
      {%- comment -%} Display hierarchical menu path {%- endcomment -%}
      {%- if menu_path != blank and menu_levels.size > 0 -%}
        
        {%- comment -%} Build breadcrumb with proper URLs for each level {%- endcomment -%}
        {%- for level in menu_levels -%}
          <li class="breadcrumb__item">
            {%- assign level_url = blank -%}
            {%- assign level_index = forloop.index0 -%}
            
            {%- comment -%} DEBUG: Show search process {%- endcomment -%}
            {%- comment -%} Try to find URL by searching through entire menu structure {%- endcomment -%}
            {%- assign search_debug = 'Searching for: ' | append: level | append: ' | ' -%}
            {%- for link in main_menu.links -%}
              {%- comment -%} Check if this is the level we're looking for {%- endcomment -%}
              {%- if link.title == level -%}
                {%- assign level_url = link.url -%}
                {%- assign search_debug = search_debug | append: 'Found at top level: ' | append: link.title | append: ' ‚Üí ' | append: link.url | append: ' | ' -%}
                {%- break -%}
              {%- endif -%}
              
              {%- comment -%} Search in children {%- endcomment -%}
              {%- if link.links != blank -%}
                {%- for childlink in link.links -%}
                  {%- if childlink.title == level -%}
                    {%- assign level_url = childlink.url -%}
                    {%- assign search_debug = search_debug | append: 'Found in ' | append: link.title | append: ': ' | append: childlink.title | append: ' ‚Üí ' | append: childlink.url | append: ' | ' -%}
                    {%- break -%}
                  {%- endif -%}
                  
                  {%- comment -%} Search in grandchildren {%- endcomment -%}
                  {%- if childlink.links != blank -%}
                    {%- for grandchildlink in childlink.links -%}
                      {%- if grandchildlink.title == level -%}
                        {%- assign level_url = grandchildlink.url -%}
                        {%- assign search_debug = search_debug | append: 'Found in ' | append: link.title | append: '‚Üí' | append: childlink.title | append: ': ' | append: grandchildlink.title | append: ' ‚Üí ' | append: grandchildlink.url | append: ' | ' -%}
                        {%- break -%}
                      {%- endif -%}
                    {%- endfor -%}
                  {%- endif -%}
                  {%- if level_url != blank -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
              {%- endif -%}
              {%- if level_url != blank -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
            
            {%- if level_url == blank -%}
              {%- assign search_debug = search_debug | append: 'NOT FOUND!' -%}
            {%- endif -%}
            
            {%- comment -%} DEBUG: Show what URL was found {%- endcomment -%}
            <!-- üîç LEVEL {{ forloop.index }}: "{{ level }}" ‚Üí URL: "{{ level_url | default: 'BLANK' }}" -->
            <!-- üìä PAGE TYPE: {{ request.page_type }} | PRODUCT: {{ product.title | default: 'N/A' }} | COLLECTION: {{ collection.title | default: 'N/A' }} -->
            
            {%- comment -%} Render breadcrumb item {%- endcomment -%}
            {%- comment -%} Check if this level represents the current page {%- endcomment -%}
            {%- assign is_current_page = false -%}
            {%- if forloop.last and request.page_type == 'product' and level == product.title -%}
              {%- assign is_current_page = true -%}
            {%- elsif forloop.last and request.page_type == 'collection' and level == collection.title -%}
              {%- assign is_current_page = true -%}
            {%- endif -%}
            
            <!-- üß™ CURRENT PAGE CHECK: forloop.last={{ forloop.last }} | is_current_page={{ is_current_page }} | level="{{ level }}" -->
            
            {%- if is_current_page -%}
              {%- comment -%} This level is the actual current page, not clickable {%- endcomment -%}
              <!-- üìå CURRENT PAGE: No link for {{ level }} -->
              <span class="breadcrumb__current">{{ level | escape }}</span>
            {%- elsif level_url != blank and level_url != '#' -%}
              {%- comment -%} Valid URL found, create link {%- endcomment -%}
              <!-- ‚úÖ VALID URL: {{ level_url }} -->
              <a href="{{ level_url }}" class="breadcrumb__link">{{ level | escape }} üîó</a>
            {%- elsif level_url == '#' -%}
              {%- comment -%} Placeholder link - try to find collection by handle {%- endcomment -%}
              {%- assign collection_handle = level | handle -%}
              {%- assign fallback_collection = collections[collection_handle] -%}
              
              {%- comment -%} DEBUG: Show fallback attempts {%- endcomment -%}
              <!-- üîÑ FALLBACK: {{ level }} ‚Üí {{ collection_handle }} ‚Üí {{ fallback_collection.url | default: 'NOT FOUND' }} -->
              
              {%- if fallback_collection -%}
                <a href="{{ fallback_collection.url }}" class="breadcrumb__link">{{ level | escape }} ‚úÖ</a>
              {%- else -%}
                {%- comment -%} Try common variations {%- endcomment -%}
                {%- assign alt_handle_1 = level | replace: ' ', '-' | downcase -%}
                {%- assign alt_handle_2 = level | replace: ' vƒÉn ph√≤ng', '' | handle -%}
                {%- assign alt_handle_3 = 'noi-that-van-phong' -%}
                {%- assign alt_handle_4 = 'noi-that' -%}
                
                <!-- üîÑ ALT HANDLES: {{ alt_handle_1 }} | {{ alt_handle_2 }} | {{ alt_handle_3 }} | {{ alt_handle_4 }} -->
                
                {%- if collections[alt_handle_1] -%}
                  <a href="{{ collections[alt_handle_1].url }}" class="breadcrumb__link">{{ level | escape }} üéØ</a>
                {%- elsif collections[alt_handle_2] -%}
                  <a href="{{ collections[alt_handle_2].url }}" class="breadcrumb__link">{{ level | escape }} üéØ</a>
                {%- elsif collections[alt_handle_3] -%}
                  <a href="{{ collections[alt_handle_3].url }}" class="breadcrumb__link">{{ level | escape }} üéØ</a>
                {%- elsif collections[alt_handle_4] -%}
                  <a href="{{ collections[alt_handle_4].url }}" class="breadcrumb__link">{{ level | escape }} üéØ</a>
                {%- else -%}
                  <!-- ‚ùå NO FALLBACK FOUND for {{ level }} -->
                  <span class="breadcrumb__link" style="color: rgba(0, 0, 0, 0.5);" title="Placeholder link (#) - No collection found">{{ level | escape }} üìÇ</span>
                {%- endif -%}
              {%- endif -%}
            {%- else -%}
              {%- comment -%} No URL found, display as text only with debug {%- endcomment -%}
              <!-- ‚ùå NO URL: "{{ level }}" ‚Üí level_url = "{{ level_url | default: 'BLANK' }}" -->
              <!-- üö® FORCE LINK TEST: Creating link anyway for debugging -->
              <a href="/collections/test-{{ level | handle }}" class="breadcrumb__link" style="border: 2px dashed red;">{{ level | escape }} üß™</a>
            {%- endif -%}
          </li>
          {%- unless forloop.last -%}
            <li class="breadcrumb__separator" aria-hidden="true">></li>
          {%- endunless -%}
        {%- endfor -%}
      {%- else -%}
        {%- comment -%} No menu path found, show regular breadcrumb logic {%- endcomment -%}
        {%- case request.page_type -%}
          {%- when 'collection' -%}
            <li class="breadcrumb__item">
              <span class="breadcrumb__current">{{ collection.title | escape }}</span>
            </li>
            
          {%- when 'product' -%}
            {%- if collection -%}
              <li class="breadcrumb__item">
                <a href="{{ collection.url }}" class="breadcrumb__link">{{ collection.title | escape }}</a>
              </li>
              <li class="breadcrumb__separator" aria-hidden="true">></li>
              <li class="breadcrumb__item">
                <span class="breadcrumb__current">{{ product.title | escape }}</span>
              </li>
            {%- elsif product.collections.size > 0 -%}
              {%- assign first_collection = product.collections.first -%}
              <li class="breadcrumb__item">
                <a href="{{ first_collection.url }}" class="breadcrumb__link">{{ first_collection.title | escape }}</a>
              </li>
              <li class="breadcrumb__separator" aria-hidden="true">></li>
              <li class="breadcrumb__item">
                <span class="breadcrumb__current">{{ product.title | escape }}</span>
              </li>
            {%- else -%}
              <li class="breadcrumb__item">
                <span class="breadcrumb__current">{{ product.title | escape }}</span>
              </li>
            {%- endif -%}
            
          {%- when 'page' -%}
            <li class="breadcrumb__item">
              <span class="breadcrumb__current">{{ page.title | escape }}</span>
            </li>
            
          {%- when 'cart' -%}
            <li class="breadcrumb__item">
              <span class="breadcrumb__current">Gi·ªè h√†ng</span>
            </li>
            
          {%- when 'search' -%}
            <li class="breadcrumb__item">
              <span class="breadcrumb__current">T√¨m ki·∫øm</span>
            </li>
            
          {%- when 'customers/account' -%}
            <li class="breadcrumb__item">
              <span class="breadcrumb__current">T√†i kho·∫£n</span>
            </li>
            
          {%- when 'customers/login' -%}
            <li class="breadcrumb__item">
              <span class="breadcrumb__current">ƒêƒÉng nh·∫≠p</span>
            </li>
            
          {%- when 'customers/register' -%}
            <li class="breadcrumb__item">
              <span class="breadcrumb__current">ƒêƒÉng k√Ω</span>
            </li>
            
          {%- else -%}
            <li class="breadcrumb__item">
              <span class="breadcrumb__current">{{ page_title | escape }}</span>
            </li>
        {%- endcase -%}
      {%- endif -%}
    {%- endif -%}
  </ol>
</nav>