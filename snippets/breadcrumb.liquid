{% comment %}
  Renders hierarchical breadcrumb navigation with full menu path

  Usage:
  {% render 'breadcrumb' %}
{% endcomment %}

{%- liquid
  # Function to find menu path for current collection/product
  # Returns array of menu items leading to current page
  
  assign menu_path = blank
  # First try to get menu from header section configuration
  assign main_menu = blank
  
  # Try common menu handles
  if linklists['main-menu'] != blank
    assign main_menu = linklists['main-menu']
  elsif linklists['header'] != blank  
    assign main_menu = linklists['header']
  elsif linklists['primary'] != blank
    assign main_menu = linklists['primary']
  endif
  
  if request.page_type == 'product' and product and main_menu != blank
    for link in main_menu.links
      if link.links != blank
        for childlink in link.links
          if childlink.links != blank
            for grandchildlink in childlink.links
              if grandchildlink.url == product.url or (collection and grandchildlink.url == collection.url)
                assign menu_path = link.title | append: '|' | append: childlink.title | append: '|' | append: grandchildlink.title
                break
              endif
            endfor
            if menu_path != blank
              break
            endif
            # Check if product belongs to this collection
            assign collection_handle = childlink.url | split: '/collections/' | last | split: '/' | first
            if product.collections contains collections[collection_handle]
              assign menu_path = link.title | append: '|' | append: childlink.title
              break
            endif
          else
            # Check single level childlink
            assign collection_handle = childlink.url | split: '/collections/' | last | split: '/' | first
            if product.collections contains collections[collection_handle]
              assign menu_path = link.title | append: '|' | append: childlink.title
              break
            endif
          endif
        endfor
        if menu_path != blank
          break
        endif
      endif
    endfor
  elsif request.page_type == 'collection' and collection and main_menu != blank
    for link in main_menu.links
      if link.links != blank
        for childlink in link.links
          if childlink.url == collection.url
            assign menu_path = link.title | append: '|' | append: childlink.title
            break
          endif
          if childlink.links != blank
            for grandchildlink in childlink.links
              if grandchildlink.url == collection.url
                assign menu_path = link.title | append: '|' | append: childlink.title | append: '|' | append: grandchildlink.title
                break
              endif
            endfor
            if menu_path != blank
              break
            endif
          endif
        endfor
        if menu_path != blank
          break
        endif
      endif
    endfor
  endif
  
  assign menu_levels = menu_path | split: '|'
-%}

<style>
  .breadcrumb {
    background: #f8f9fa;
    border-bottom: 1px solid #e5e7eb;
    padding: 12px 0;
    font-size: 14px;
  }
  
  .breadcrumb__list {
    display: flex;
    align-items: center;
    margin: 0;
    padding: 0;
    list-style: none;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 24px;
  }
  
  .breadcrumb__item {
    display: flex;
    align-items: center;
  }
  
  .breadcrumb__link {
    color: rgba(0, 0, 0, 0.6);
    text-decoration: none;
    transition: color 0.2s ease;
    text-transform: none;
    font-size: 13px;
    font-weight: 500;
  }
  
  .breadcrumb__link:hover {
    color: rgba(0, 0, 0, 0.8);
  }
  
  .breadcrumb__current {
    color: rgba(0, 0, 0, 0.8);
    font-weight: 600;
    text-transform: none;
    font-size: 13px;
  }
  
  .breadcrumb__separator {
    margin: 0 12px;
    color: rgba(0, 0, 0, 0.4);
    font-size: 12px;
  }
  
  @media (max-width: 768px) {
    .breadcrumb__list {
      padding: 0 16px;
    }
    
    .breadcrumb__link,
    .breadcrumb__current {
      font-size: 12px;
    }
    
    .breadcrumb__separator {
      margin: 0 8px;
    }
  }
</style>

<nav class="breadcrumb" aria-label="Breadcrumb">
  <ol class="breadcrumb__list">
    <!-- Home -->
    <li class="breadcrumb__item">
      <a href="{{ routes.root_url }}" class="breadcrumb__link">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="margin-right: 4px;">
          <path d="M3 12L5 10M5 10L12 3L19 10M5 10V20A1 1 0 006 21H9M19 10L21 12M19 10V20A1 1 0 0018 21H15M9 21V16A1 1 0 0110 15H14A1 1 0 0115 16V21M9 21H15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Trang chủ
      </a>
    </li>

    {%- unless request.page_type == 'index' -%}
      <li class="breadcrumb__separator" aria-hidden="true">></li>
      
      {%- comment -%} Display hierarchical menu path {%- endcomment -%}
      {%- if menu_path != blank and menu_levels.size > 0 -%}
        {%- for level in menu_levels -%}
          <li class="breadcrumb__item">
            {%- comment -%} Try to find the URL for this menu level {%- endcomment -%}
            {%- assign level_url = blank -%}
            {%- for link in main_menu.links -%}
              {%- if link.title == level -%}
                {%- assign level_url = link.url -%}
                {%- break -%}
              {%- endif -%}
              {%- if link.links != blank -%}
                {%- for childlink in link.links -%}
                  {%- if childlink.title == level -%}
                    {%- assign level_url = childlink.url -%}
                    {%- break -%}
                  {%- endif -%}
                  {%- if childlink.links != blank -%}
                    {%- for grandchildlink in childlink.links -%}
                      {%- if grandchildlink.title == level -%}
                        {%- assign level_url = grandchildlink.url -%}
                        {%- break -%}
                      {%- endif -%}
                    {%- endfor -%}
                  {%- endif -%}
                  {%- if level_url != blank -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
              {%- endif -%}
              {%- if level_url != blank -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
            
            {%- if forloop.last -%}
              {%- comment -%} Last level is current, not clickable {%- endcomment -%}
              <span class="breadcrumb__current">{{ level | escape }}</span>
            {%- elsif level_url != blank -%}
              <a href="{{ level_url }}" class="breadcrumb__link">{{ level | escape }}</a>
            {%- else -%}
              <span class="breadcrumb__link">{{ level | escape }}</span>
            {%- endif -%}
          </li>
          {%- unless forloop.last -%}
            <li class="breadcrumb__separator" aria-hidden="true">></li>
          {%- endunless -%}
        {%- endfor -%}
      {%- else -%}
        {%- comment -%} No menu path found, continue with regular breadcrumb logic {%- endcomment -%}
      {%- if menu_path == blank -%}
        {%- comment -%} Only show regular breadcrumb logic if no menu path found {%- endcomment -%}
        {%- case request.page_type -%}
          {%- when 'collection' -%}
            <li class="breadcrumb__item">
              <span class="breadcrumb__current">{{ collection.title | escape }}</span>
            </li>
            
          {%- when 'product' -%}
            {%- comment -%} For products, show full menu hierarchy path only, no product name {%- endcomment -%}
            {%- if menu_path != blank and menu_levels.size > 0 -%}
              {%- comment -%} Menu path already displayed above, show last level if not already shown {%- endcomment -%}
              {%- assign last_level = menu_levels.last -%}
              <li class="breadcrumb__item">
                <span class="breadcrumb__current">{{ last_level | escape }}</span>
              </li>
            {%- elsif collection -%}
              {%- comment -%} Fallback to collection if no menu path found {%- endcomment -%}
              <li class="breadcrumb__item">
                <span class="breadcrumb__current">{{ collection.title | escape }}</span>
              </li>
            {%- else -%}
              {%- comment -%} Fallback for products without collection {%- endcomment -%}
              <li class="breadcrumb__item">
                <span class="breadcrumb__current">Sản phẩm</span>
              </li>
            {%- endif -%}
            
          {%- when 'blog' -%}
            <li class="breadcrumb__item">
              <span class="breadcrumb__current">{{ blog.title | escape }}</span>
            </li>
            
          {%- when 'article' -%}
            <li class="breadcrumb__item">
              <a href="{{ blog.url }}" class="breadcrumb__link">{{ blog.title | escape }}</a>
            </li>
            <li class="breadcrumb__separator" aria-hidden="true">></li>
            <li class="breadcrumb__item">
              <span class="breadcrumb__current">{{ article.title | escape }}</span>
            </li>
            
          {%- when 'page' -%}
            <li class="breadcrumb__item">
              <span class="breadcrumb__current">{{ page.title | escape }}</span>
            </li>
            
          {%- when 'cart' -%}
            <li class="breadcrumb__item">
              <span class="breadcrumb__current">Giỏ hàng</span>
            </li>
            
          {%- when 'search' -%}
            <li class="breadcrumb__item">
              <span class="breadcrumb__current">
                {%- if search.performed -%}
                  Kết quả tìm kiếm cho "{{ search.terms | escape }}"
                {%- else -%}
                  Tìm kiếm
                {%- endif -%}
              </span>
            </li>
            
          {%- when 'list-collections' -%}
            <li class="breadcrumb__item">
              <span class="breadcrumb__current">Tất cả danh mục</span>
            </li>
            
          {%- when '404' -%}
            <li class="breadcrumb__item">
              <span class="breadcrumb__current">Không tìm thấy trang</span>
            </li>
            
          {%- else -%}
            <li class="breadcrumb__item">
              <span class="breadcrumb__current">{{ page_title | escape }}</span>
            </li>
        {%- endcase -%}
      {%- endif -%}
    {%- endunless -%}
  </ol>
</nav>
