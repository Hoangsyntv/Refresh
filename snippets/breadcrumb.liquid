{%- liquid
  comment 'Breadcrumb navigation following proper spec'
  endcomment
  
  comment '0) Get main menu for hierarchy detection'
  endcomment
  assign main_menu = blank
  if linklists['main-menu'] != blank
    assign main_menu = linklists['main-menu']
  elsif linklists['header'] != blank  
    assign main_menu = linklists['header']
  elsif linklists['primary'] != blank
    assign main_menu = linklists['primary']
  endif
  
  comment '1) Determine crumb_collection with priority order'
  endcomment
  assign primary_collection = product.metafields.custom.primary_collection
  
  if request.page_type == 'product'
    if collection
      assign crumb_collection = collection
      assign collection_source = 'URL context'
    elsif primary_collection
      assign crumb_collection = primary_collection
      assign collection_source = 'Primary metafield'
    elsif product.collections.size > 0
      assign crumb_collection = product.collections | first
      assign collection_source = 'First collection'
    else
      assign crumb_collection = nil
      assign collection_source = 'None'
    endif
  elsif request.page_type == 'collection'
    comment 'For collection pages, use current collection and build parent chain'
    endcomment
    assign crumb_collection = collection
    assign collection_source = 'Current collection'
  else
    assign crumb_collection = nil
    assign collection_source = 'Not applicable'
  endif
  
  comment '2) Build ancestor chain from menu hierarchy and metafields'
  endcomment
  assign ancestors = '' | split: ''
  assign menu_ancestors = '' | split: ''
  
  comment 'Find current collection in menu structure'
  endcomment
  assign target_collection = nil
  if request.page_type == 'collection'
    assign target_collection = collection
  elsif request.page_type == 'product' and crumb_collection
    assign target_collection = crumb_collection
  endif
  
  if target_collection and main_menu
    comment 'Search for collection in menu hierarchy (3 levels max)'
    endcomment
    for link in main_menu.links
      comment 'Level 1: Check top level'
      endcomment
      if link.url == target_collection.url
        assign menu_found = true
        break
      endif
      
      comment 'Level 2: Check second level'
      endcomment
      if link.links.size > 0
        for childlink in link.links
          if childlink.url == target_collection.url
            assign menu_ancestors = menu_ancestors | push: link
            assign menu_found = true
            break
          endif
          
          comment 'Level 3: Check third level'
          endcomment
          if childlink.links.size > 0
            for grandchildlink in childlink.links
              if grandchildlink.url == target_collection.url
                assign menu_ancestors = menu_ancestors | push: link
                assign menu_ancestors = menu_ancestors | push: childlink
                assign menu_found = true
                break
              endif
            endfor
            if menu_found
              break
            endif
          endif
        endfor
        if menu_found
          break
        endif
      endif
    endfor
  endif
  
  comment 'Use menu hierarchy as primary source, fallback to metafields'
  endcomment
  if menu_ancestors.size > 0
    assign ancestors = menu_ancestors
  else
    comment 'Fallback to metafield-based hierarchy'
    endcomment
    if request.page_type == 'collection'
      assign current_collection = collection
      assign max_depth = 3
      
      for i in (1..max_depth)
        if current_collection and current_collection.metafields.custom.parent_collection
          assign parent = current_collection.metafields.custom.parent_collection
          assign ancestors = ancestors | push: parent
          assign current_collection = parent
        else
          break
        endif
      endfor
    elsif crumb_collection
      assign current_collection = crumb_collection
      assign max_depth = 3
      
      for i in (1..max_depth)
        if current_collection and current_collection.metafields.custom.parent_collection
          assign parent = current_collection.metafields.custom.parent_collection
          assign ancestors = ancestors | push: parent
          assign current_collection = parent
        else
          break
        endif
      endfor
    endif
  endif
-%}

<style>
  .breadcrumb {
    background: #f8f9fa !important;
    border-bottom: 1px solid #e5e7eb !important;
    padding: 12px 0 !important;
    font-size: 14px !important;
    z-index: -1 !important;
    position: relative !important;
  }
  
  .breadcrumb__list {
    display: flex !important;
    align-items: center !important;
    margin: 0 !important;
    padding: 0 !important;
    list-style: none !important;
    max-width: 1200px !important;
    margin: 0 auto !important;
    padding: 0 20px !important;
  }
  
  .breadcrumb__item {
    display: flex !important;
    align-items: center !important;
  }
  
  .breadcrumb__link {
    color: rgba(0, 0, 0, 0.6) !important;
    text-decoration: none !important;
    font-weight: 500 !important;
    transition: all 0.2s ease !important;
    font-size: 13px !important;
    font-family: 'Inter', 'Roboto', 'Noto Sans', var(--font-body-family), -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif !important;
  }
  
  .breadcrumb__link:hover {
    color: rgba(0, 0, 0, 0.9) !important;
    text-decoration: underline !important;
  }
  
  .breadcrumb__current {
    color: rgba(0, 0, 0, 0.8) !important;
    font-weight: 600 !important;
    text-transform: none !important;
    font-size: 13px !important;
    font-family: 'Inter', 'Roboto', 'Noto Sans', var(--font-body-family), -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif !important;
  }
  
  .breadcrumb__separator {
    margin: 0 12px !important;
    color: rgba(0, 0, 0, 0.4) !important;
    font-size: 12px !important;
  }
</style>

<nav class="breadcrumb" aria-label="Breadcrumb">
  <!-- DEBUG: Collection Resolution -->
  <div style="background: #f0f8ff; padding: 8px; margin: 8px 0; font-size: 11px; border: 1px solid #ddd;">
    <strong>üéØ COLLECTION RESOLVER:</strong><br>
    Page Type: {{ request.page_type }}<br>
    Source: {{ collection_source | default: 'None' }}<br>
    Collection Context: {{ collection.title | default: 'None' }}<br>
    Primary Metafield: {{ primary_collection.title | default: 'None' }}<br>
    First Collection: {{ product.collections.first.title | default: 'None' }}<br>
    Selected: {{ crumb_collection.title | default: 'None' }}<br>
    
    <strong>üçî MENU HIERARCHY:</strong><br>
    Menu Available: {{ main_menu != blank }}<br>
    Target Collection: {{ target_collection.title | default: 'None' }}<br>
    Target Collection URL: {{ target_collection.url | default: 'None' }}<br>
    Menu Found: {{ menu_found | default: 'false' }}<br>
    Menu Ancestors: 
    {%- for menu_ancestor in menu_ancestors -%}
      {{ menu_ancestor.title }}{% unless forloop.last %} ‚Üí {% endunless %}
    {%- else -%}
      None
    {%- endfor -%}<br>
    
    <strong>üîç MENU STRUCTURE DEBUG:</strong><br>
    {%- if main_menu -%}
      {%- for link in main_menu.links limit: 3 -%}
        <strong>L1:</strong> {{ link.title }} ({{ link.url }})<br>
        {%- if link.links.size > 0 -%}
          {%- for childlink in link.links limit: 3 -%}
            &nbsp;&nbsp;<strong>L2:</strong> {{ childlink.title }} ({{ childlink.url }})
            {%- if childlink.url == target_collection.url -%} <span style="color: red;">‚Üê MATCH!</span>{%- endif -%}<br>
            {%- if childlink.links.size > 0 -%}
              {%- for grandchildlink in childlink.links limit: 3 -%}
                &nbsp;&nbsp;&nbsp;&nbsp;<strong>L3:</strong> {{ grandchildlink.title }} ({{ grandchildlink.url }})
                {%- if grandchildlink.url == target_collection.url -%} <span style="color: red;">‚Üê MATCH!</span>{%- endif -%}<br>
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      {%- endfor -%}
    {%- else -%}
      No menu available
    {%- endif -%}
    
    <strong>üîç PARENT CHAIN DEBUG:</strong><br>
    Current Collection: {{ collection.title | default: 'None' }}<br>
    Has Parent Metafield: {{ collection.metafields.custom.parent_collection | default: 'false' }}<br>
    Parent Collection: {{ collection.metafields.custom.parent_collection.title | default: 'None' }}<br>
    Parent Collection ID: {{ collection.metafields.custom.parent_collection.id | default: 'None' }}<br>
    
    <strong>üèóÔ∏è FINAL ANCESTORS:</strong>
    {%- for ancestor in ancestors -%}
      {{ ancestor.title }}{% unless forloop.last %} ‚Üí {% endunless %}
    {%- else -%}
      None
    {%- endfor -%}<br>
    <strong>üìã FULL PATH:</strong>
    Trang ch·ªß
    {%- for ancestor in ancestors reversed -%}
      ‚Üí {{ ancestor.title }}
    {%- endfor -%}
    {%- case request.page_type -%}
      {%- when 'product' -%}
        {%- if crumb_collection -%}
          ‚Üí {{ crumb_collection.title }}
        {%- endif -%}
        ‚Üí {{ product.title }}
      {%- when 'collection' -%}
        ‚Üí {{ collection.title }}
      {%- when 'page' -%}
        ‚Üí {{ page.title }}
      {%- else -%}
        {%- if crumb_collection -%}
          ‚Üí {{ crumb_collection.title }}
        {%- endif -%}
    {%- endcase -%}
  </div>

  <ol class="breadcrumb__list">
    <!-- Home -->
    <li class="breadcrumb__item">
      <a href="{{ routes.root_url }}" class="breadcrumb__link">
        üè† Trang ch·ªß
      </a>
    </li>

    {%- if request.page_type != 'index' -%}
      <li class="breadcrumb__separator" aria-hidden="true">></li>
      
      {%- comment -%} Render ancestor chain (if any) {%- endcomment -%}
      {%- for ancestor in ancestors reversed -%}
        <li class="breadcrumb__item">
          <a href="{{ ancestor.url }}" class="breadcrumb__link">{{ ancestor.title | escape }}</a>
        </li>
        <li class="breadcrumb__separator" aria-hidden="true">></li>
      {%- endfor -%}
      
      {%- comment -%} Render collection link (except on collection pages where it would be current) {%- endcomment -%}
      {%- if crumb_collection and request.page_type != 'collection' -%}
        <li class="breadcrumb__item">
          <a href="{{ crumb_collection.url }}" class="breadcrumb__link">{{ crumb_collection.title | escape }}</a>
        </li>
        <li class="breadcrumb__separator" aria-hidden="true">></li>
      {%- endif -%}
      
      {%- comment -%} Render current page based on page type {%- endcomment -%}
      {%- case request.page_type -%}
        {%- when 'product' -%}
          <li class="breadcrumb__item">
            <span class="breadcrumb__current" aria-current="page">{{ product.title | escape }}</span>
          </li>
          
        {%- when 'collection' -%}
          <li class="breadcrumb__item">
            <span class="breadcrumb__current" aria-current="page">{{ collection.title | escape }}</span>
          </li>
          
        {%- when 'page' -%}
          <li class="breadcrumb__item">
            <span class="breadcrumb__current" aria-current="page">{{ page.title | escape }}</span>
          </li>
          
        {%- when 'blog' -%}
          <li class="breadcrumb__item">
            <span class="breadcrumb__current" aria-current="page">{{ blog.title | escape }}</span>
          </li>
          
        {%- when 'article' -%}
          <li class="breadcrumb__item">
            <span class="breadcrumb__current" aria-current="page">{{ article.title | escape }}</span>
          </li>
      {%- endcase -%}
    {%- endif -%}
  </ol>
</nav>
