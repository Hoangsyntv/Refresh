{%- liquid
  comment 'Breadcrumb navigation with working hierarchy and URL mapping'
  endcomment
  assign menu_handle = 'main-menu'
  assign main_menu = linklists[menu_handle]
  assign menu_path = blank

  comment 'Build menu path for products and collections'
  endcomment
  if request.page_type == 'product' and product and main_menu
    comment 'Get target collection for hierarchy detection - prefer most specific collection'
    endcomment
    assign target_collection = collection
    if target_collection == blank and product.collections.size > 0
      comment 'Find the most specific collection (longest hierarchy)'
      endcomment
      assign best_collection = blank
      assign best_hierarchy_length = 0
      
      for prod_collection in product.collections
        assign hierarchy_length = 0
        case prod_collection.handle
          when 'ban-lam-viec', 'ban-giam-doc', 'ban-chan-sat', 'ban-may-tinh'
            assign hierarchy_length = 3
          when 'ghe-giam-doc', 'ghe-xoay-van-phong', 'ghe-chan-quy'
            assign hierarchy_length = 3
          when 'tu-ho-so-giam-doc', 'tu-tai-lieu'
            assign hierarchy_length = 3
          when 'ban-van-phong', 'ghe-van-phong', 'tu-van-phong'
            assign hierarchy_length = 2
          when 'noi-that-van-phong'
            assign hierarchy_length = 1
        endcase
        
        if hierarchy_length > best_hierarchy_length
          assign best_collection = prod_collection
          assign best_hierarchy_length = hierarchy_length
        endif
      endfor
      
      assign target_collection = best_collection | default: product.collections.first
    endif
    
    if target_collection
      comment 'Manual mapping for known collection hierarchies'
      endcomment
      case target_collection.handle
        when 'ban-lam-viec'
          assign menu_path = 'N·ªôi th·∫•t vƒÉn ph√≤ng|B√†n vƒÉn ph√≤ng|B√†n l√†m vi·ªác'
        when 'ban-giam-doc'
          assign menu_path = 'N·ªôi th·∫•t vƒÉn ph√≤ng|B√†n vƒÉn ph√≤ng|B√†n gi√°m ƒë·ªëc'
        when 'ban-chan-sat'
          assign menu_path = 'N·ªôi th·∫•t vƒÉn ph√≤ng|B√†n vƒÉn ph√≤ng|B√†n ch√¢n s·∫Øt'
        when 'ban-may-tinh'
          assign menu_path = 'N·ªôi th·∫•t vƒÉn ph√≤ng|B√†n vƒÉn ph√≤ng|B√†n m√°y t√≠nh'
        when 'ban-van-phong'
          assign menu_path = 'N·ªôi th·∫•t vƒÉn ph√≤ng|B√†n vƒÉn ph√≤ng'
        when 'ghe-giam-doc'
          assign menu_path = 'N·ªôi th·∫•t vƒÉn ph√≤ng|Gh·∫ø vƒÉn ph√≤ng|Gh·∫ø gi√°m ƒë·ªëc'
        when 'ghe-xoay-van-phong'
          assign menu_path = 'N·ªôi th·∫•t vƒÉn ph√≤ng|Gh·∫ø vƒÉn ph√≤ng|Gh·∫ø xoay vƒÉn ph√≤ng'
        when 'ghe-chan-quy'
          assign menu_path = 'N·ªôi th·∫•t vƒÉn ph√≤ng|Gh·∫ø vƒÉn ph√≤ng|Gh·∫ø ch√¢n qu·ª≥'
        when 'ghe-van-phong'
          assign menu_path = 'N·ªôi th·∫•t vƒÉn ph√≤ng|Gh·∫ø vƒÉn ph√≤ng'
        when 'tu-ho-so-giam-doc'
          assign menu_path = 'N·ªôi th·∫•t vƒÉn ph√≤ng|T·ªß vƒÉn ph√≤ng|T·ªß h·ªì s∆° gi√°m ƒë·ªëc'
        when 'tu-tai-lieu'
          assign menu_path = 'N·ªôi th·∫•t vƒÉn ph√≤ng|T·ªß vƒÉn ph√≤ng|T·ªß t√†i li·ªáu'
        when 'tu-van-phong'
          assign menu_path = 'N·ªôi th·∫•t vƒÉn ph√≤ng|T·ªß vƒÉn ph√≤ng'
        when 'noi-that-van-phong'
          assign menu_path = 'N·ªôi th·∫•t vƒÉn ph√≤ng'
        else
          comment 'Fallback: Try dynamic detection'
          endcomment
          for link in main_menu.links
            if link.url == target_collection.url
              assign menu_path = link.title
              break
            endif
            if link.links != blank
              for childlink in link.links
                if childlink.url == target_collection.url
                  assign menu_path = link.title | append: '|' | append: childlink.title
                  break
                endif
                if childlink.links != blank
                  for grandchildlink in childlink.links
                    if grandchildlink.url == target_collection.url
                      assign menu_path = link.title | append: '|' | append: childlink.title | append: '|' | append: grandchildlink.title
                      break
                    endif
                  endfor
                  if menu_path != blank
                    break
                  endif
                endif
              endfor
              if menu_path != blank
                break
              endif
            endif
          endfor
      endcase
    endif
  elsif request.page_type == 'collection' and collection and main_menu
    comment 'Find collection in menu hierarchy'
    endcomment
    for link in main_menu.links
      if link.url == collection.url
        assign menu_path = link.title
        break
      endif
      if link.links != blank
        for childlink in link.links
          if childlink.url == collection.url
            assign menu_path = link.title | append: '|' | append: childlink.title
            break
          endif
          if childlink.links != blank
            for grandchildlink in childlink.links
              if grandchildlink.url == collection.url
                assign menu_path = link.title | append: '|' | append: childlink.title | append: '|' | append: grandchildlink.title
                break
              endif
            endfor
            if menu_path != blank
              break
            endif
          endif
        endfor
        if menu_path != blank
          break
        endif
      endif
    endfor
  endif
  
  assign menu_levels = menu_path | split: '|'
  
  comment 'Initialize level_urls for URL mapping'
  endcomment
  assign level_urls = ''
-%}

<style>
  .breadcrumb {
    background: #f8f9fa !important;
    border-bottom: 1px solid #e5e7eb !important;
    padding: 12px 0 !important;
    font-size: 14px !important;
    z-index: -1 !important;
    position: relative !important;
  }
  
  .breadcrumb__list {
    display: flex !important;
    align-items: center !important;
    margin: 0 !important;
    padding: 0 !important;
    list-style: none !important;
    max-width: 1200px !important;
    margin: 0 auto !important;
    padding: 0 20px !important;
  }
  
  .breadcrumb__item {
    display: flex !important;
    align-items: center !important;
  }
  
  .breadcrumb__link {
    color: rgba(0, 0, 0, 0.6) !important;
    text-decoration: none !important;
    font-weight: 500 !important;
    transition: all 0.2s ease !important;
    font-size: 13px !important;
    font-family: 'Inter', 'Roboto', 'Noto Sans', var(--font-body-family), -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif !important;
  }
  
  .breadcrumb__link:hover {
    color: rgba(0, 0, 0, 1) !important;
    text-decoration: underline !important;
    font-weight: 600 !important;
  }
  
  .breadcrumb__current {
    color: rgba(0, 0, 0, 0.8) !important;
    font-weight: 600 !important;
    text-transform: none !important;
    font-size: 13px !important;
    font-family: 'Inter', 'Roboto', 'Noto Sans', var(--font-body-family), -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif !important;
  }
  
  .breadcrumb__separator {
    margin: 0 12px !important;
    color: rgba(0, 0, 0, 0.4) !important;
    font-size: 12px !important;
  }
</style>

{%- liquid
  comment 'DEBUG: Show collection handle and mapping result'
  endcomment
  assign debug_collection = target_collection | default: collection
  assign debug_info = 'COLLECTION_HANDLE: ' | append: debug_collection.handle | append: ' | MAPPED_PATH: ' | append: menu_path | append: ' | LEVELS: ' | append: menu_levels.size
-%}

<!-- DEBUG INFO -->
<div style="background: #ffebee; padding: 8px; margin: 8px 0; border: 1px solid #f44336; font-size: 12px;">
  {{ debug_info }}
</div>

<nav class="breadcrumb" aria-label="Breadcrumb">
  <ol class="breadcrumb__list">
    <li class="breadcrumb__item">
      <a href="{{ routes.root_url }}" class="breadcrumb__link">üè† Trang ch·ªß</a>
    </li>

    {%- if request.page_type != 'index' -%}
      <li class="breadcrumb__separator" aria-hidden="true">></li>
      
      {%- if menu_path != blank and menu_levels.size > 0 -%}
        {%- for level in menu_levels -%}
          {%- assign found_url = blank -%}
          {%- for link in main_menu.links -%}
            {%- if link.title == level -%}
              {%- assign found_url = link.url -%}
              {%- break -%}
            {%- endif -%}
            {%- if link.links != blank -%}
              {%- for childlink in link.links -%}
                {%- if childlink.title == level -%}
                  {%- assign found_url = childlink.url -%}
                  {%- break -%}
                {%- endif -%}
                {%- if childlink.links != blank -%}
                  {%- for grandchildlink in childlink.links -%}
                    {%- if grandchildlink.title == level -%}
                      {%- assign found_url = grandchildlink.url -%}
                      {%- break -%}
                    {%- endif -%}
                  {%- endfor -%}
                {%- endif -%}
                {%- if found_url != blank -%}
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            {%- if found_url != blank -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
          
          <li class="breadcrumb__item">
            <a href="{{ found_url }}" class="breadcrumb__link">{{ level | escape }}</a>
          </li>
          {%- unless forloop.last -%}
            <li class="breadcrumb__separator" aria-hidden="true">></li>
          {%- endunless -%}
        {%- endfor -%}
        
        {%- comment -%} For products: No need to show product title, hierarchy ends at containing collection {%- endcomment -%}
      {%- else -%}
        {%- case request.page_type -%}
          {%- when 'collection' -%}
            <li class="breadcrumb__item">
              <a href="{{ collection.url }}" class="breadcrumb__link">{{ collection.title | escape }}</a>
            </li>
          {%- when 'product' -%}
            {%- comment -%} For products without menu hierarchy, show collection from target_collection {%- endcomment -%}
            {%- assign fallback_collection = target_collection | default: collection -%}
            {%- if fallback_collection -%}
              <li class="breadcrumb__item">
                <a href="{{ fallback_collection.url }}" class="breadcrumb__link">{{ fallback_collection.title | escape }}</a>
              </li>
            {%- endif -%}
        {%- endcase -%}
      {%- endif -%}
    {%- endif -%}
  </ol>
</nav>
